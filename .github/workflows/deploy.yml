name: Auto Deploy Laravel to EC2

on:
  push:
    branches:
      - main  # Change if your branch is different

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest

    steps:
      - name: Deploy over SSH
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "✅ SSH connection successful"

            PROJECT_DIR="/var/www/laravel-app"

            # If project folder doesn't exist, clone it
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "📦 Project not found. Cloning..."
              git clone ${{ secrets.GIT_REPO }} $PROJECT_DIR
            else
              echo "📂 Project found. Pulling latest changes..."
              cd $PROJECT_DIR
              git reset --hard
              git clean -df
              git pull origin main
            fi

            cd $PROJECT_DIR

            echo "🔧 Installing dependencies..."
            composer install --no-dev --optimize-autoloader

            echo "🔐 Setting up Laravel .env"
            if [ ! -f .env ]; then
              cp .env.example .env
            fi

            echo "🔑 Generating app key..."
            php artisan key:generate --force || true

            echo "🔗 Creating storage link..."
            php artisan storage:link || true

            echo "⚙️ Caching config, routes, and views..."
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache

            echo "🧬 Running migrations..."
            php artisan migrate --force

            echo "🔐 Setting permissions..."
            chmod -R 775 storage bootstrap/cache
            chown -R www-data:www-data .

            echo "🚀 Deployment complete!"
